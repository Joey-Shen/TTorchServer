<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>TTorch</title>

    <style type="text/css">

        #map {
            width: 1000px;
            height: 500px;
            margin-top: 50px;
            margin-left: 250px;
        }

    </style>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.2/css/bootstrap.min.css" integrity="sha384-Smlep5jCw/wG7hdkwQ/Z5nLIefveQRIY9nfy6xoR1uRYBtpZgI6339F5dgvm/e9B" crossorigin="anonymous">
    <link rel="stylesheet" href="http://api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.css" />
</head>
<body>

<div style="width: 65%; margin-left:300px; background-color: powderblue">
    <div class="btn-group" style="margin-top: 50px; margin-left: 180px" role="group" aria-label="Basic example">
        <button id="btn0" type="button" style="margin-right: 1px" class="btn btn-primary" value=0>Similarity Search
        </button>
        <button id="btn1" type="button" style="margin-right: 1px" class="btn btn-secondary" value=1>Range Search
        </button>
        <button id="btn2" type="button" style="margin-right: 1px" class="btn btn-secondary" value=2>Path Query</button>
        <button id="btn3" type="button" style="margin-right: 1px" class="btn btn-secondary" value=3>Strict Path Query
        </button>
    </div>

    <div class="input-group mb-3" style="margin-top: 20px; margin-right:10px">
        <input type="text" id="input" class="form-control" size="25" placeholder="draw the window for RangeSearch, or the path for other types of queries"
               aria-label="search" aria-describedby="button-addon4" style="margin-left: 50px">
        <div class="input-group-append" id="button-addon4">
            <button class="btn btn-outline-danger" id="btnClear" type="button">Clear</button>
            <button class="btn btn-outline-success" id="btnSearch" style="margin-left: 1px" type="button">Search
            </button>
        </div>
    </div>

    <div id="info" class="alert alert-warning" role="alert" style="margin-left: 220px; width: 450px; font-size: medium; display: none">
        <p style="align-content: center ">A simple warning alert—check it out!</p>
    </div>
</div>

<div id="map"></div>
<canvas id="canvas"></canvas>

<!-- JavaScript field -->
<script src="https://code.jquery.com/jquery-3.3.1.js"
        integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.2/js/bootstrap.min.js"
        integrity="sha384-o+RDsa0aLu++PJvFqy8fFScvbHFLtbvScb8AjopnFD+iEQ7wo/CG0xlczd+2O/em"
        crossorigin="anonymous"></script>
<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=o55gGAr8In322oxznMl5cojFABFo5hjE"></script>
<script type="text/javascript"
        src="http://api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.js"></script>
<script src="http://mapv.baidu.com/build/mapv.min.js"></script>
<script type="text/javascript">

    const SIMILARITY_SEARCH = 0;
    const RANGE_SEARCH = 1;
    const PATH_QUERY = 2;
    const STRICT_PATH_QUERY = 3;

    const urlPrefix = "http://localhost:8080";
    const apiMap = {
        0:"/TTorchServer/API/TKQ",
        1:"/TTorchServer/API/RQ",
        2:"/TTorchServer/API/PQ",
        3:"/TTorchServer/API/SPQ"
    };

    $(document).ready(() => {

        // set listeners for query type selection group
        // record current selected btn.
        // 0 -- similarity search btn
        // 1 -- range search btn
        // 2 -- path query btn
        // 3 -- strict path query btn;
        let curBtnState = 0;
        for (let i = 0; i <= 3; i++) {
            let curBtn = $('#btn' + i);
            curBtn.click(() => {
                if (curBtnState !== i) {
                    $('#btn'+curBtnState).removeClass("btn-primary").addClass("btn-secondary");
                    curBtn.removeClass("btn-secondary").addClass("btn-primary");
                    curBtnState = parseInt(curBtn.val());
                }
            });
        }

        // baidu API
        let map = new BMap.Map("map");    // 创建Map实例
        map.centerAndZoom(new BMap.Point(-8.630568, 41.154795), 14);  // 初始化地图,设置中心点坐标和地图级别
        map.enableScrollWheelZoom(true); // 开启鼠标滚轮缩放
        map.setMapStyle({style: 'light'});

        let path = "";                  // used for other query types
        let window = "";                // used for range query

        let pathStyle = {
            strokeColor: "blue",
            strokeWeight: 6,             // width of the stroke
            strokeOpacity: 0.5,
            strokeStyle: "dashed"        // solid or dashed
        };

        let rectStyle = {
            strokeColor: "red",
            fillColor: "red",
            strokeOpacity: 0.1,
            fillOpacity: 0.3,
            strokeStyle: "solid"
        };

        let drawer = new BMapLib.DrawingManager(map, {
            isOpen: false,                          // disable drawing mode
            enableDrawingTool: true,                // display tool bar
            drawingToolOptions: {
                anchor: BMAP_ANCHOR_TOP_RIGHT,      // position of the tool bar
                offset: new BMap.Size(10, 40),        // offset from the position
                scale: 0.8,
                drawingModes: [                    // functions on tool bar
                    // BMAP_DRAWING_MARKER,
                    // BMAP_DRAWING_CIRCLE,
                    BMAP_DRAWING_POLYLINE,
                    // BMAP_DRAWING_POLYGON,
                    BMAP_DRAWING_RECTANGLE
                ]
            },
            polylineOptions: pathStyle,
            rectangleOptions: rectStyle
        });

        function clear1() {
            $("#input").val("");
            map.clearOverlays();
            let infoElement = $('#info');
            infoElement.text("");
            infoElement.hide();
            path = "";
            window = "";
        }

        function badInfo( content) {
            let element = $('#info');
            element.removeClass("alert-success").addClass("alert-warning")
            element.text(content);
            element.show();
        }

        function goodInfo( content){
            let element = $('#info');
            element.removeClass("alert-warning").addClass("alert-success")
            element.text(content);
            element.show();
        }

        let lineComplete = function(line){

            if (curBtnState !== RANGE_SEARCH) {
                let temp = line.getPath();
                path = "[";
                temp.forEach((item) => {
                    path += "[" + item.lat + "," + item.lng + "],"
                });
                path = path.substr(0, path.length - 1);
                path += "]";
                $("#input").val(path);
                $('#info').hide();
            }else{
                badInfo("Current query type do not support a PATH as query!")
            }
        };

        let rectComplete = (rect) => {

            console.log("cur btn state: "+curBtnState);
            console.log("range search: "+RANGE_SEARCH);

            if (curBtnState === RANGE_SEARCH) {
                // 0 -- upper left
                // 1 -- upper right
                // 2 -- lower right
                // 3 -- lower left
                let temp = [
                    rect.getPath()[0],
                    rect.getPath()[2]
                ];
                window = "[";
                temp.forEach((item) => {
                    window += "[" + item.lat + "," + item.lng + "],"
                });
                window = window.substr(0, window.length - 1);
                window += "]";
                $("#input").val(window);
                $('#info').hide();
            }else{
                badInfo("Current query type do not support a WINDOW as query!");
            }
        };

        drawer.addEventListener("polylinecomplete", lineComplete);

        drawer.addEventListener("rectanglecomplete", rectComplete);


        // todo set listeners for clear button and submit button
        $("#btnClear").click(()=>{
            clear1();
        });

        $("#btnSearch").click(()=>{

            let url = urlPrefix + apiMap[curBtnState];
            let data;
            console.log(url);
            if (curBtnState === RANGE_SEARCH){
                if (window === "") {
                    badInfo("A window for the query is required!");
                    return;
                }

                if (window.split("],[").length !== 2) {
                    badInfo("A window is defined by an upper left point and a lower right point");
                    return;
                }
                data = {query: window};
            } else {
                if (path === "") {
                    badInfo("A path for the query is required!");
                    return;
                }

                if (path.split("],[").length < 2) {
                    badInfo("A path is defined by two or more points");
                    return;
                }

                if (curBtnState === SIMILARITY_SEARCH) {
                    data = {
                        query: path,
                        k: 5
                    }
                }else {
                    data = {query: path};
                }
            }
            console.log(data);

            goodInfo("The query is under processing, please wait...")

            $.ajax({
                url: url,
                data: data,
                dataType:'json',
                cache: false,
                type: "GET",
                success: function(res) {
                    // clear1();
                    console.log(res);
                    let retObj = JSON.parse(res.queryResult);
                    let formatCorrect = JSON.parse(res.formatCorrect);
                    if (!formatCorrect) {
                        badInfo("Query is not in the right format. Please do double check!");
                        return;
                    }
                    
                    if (!retObj.mappingSucceed){
                        badInfo("Query can not be properly map-matched to road network!")
                        return;
                    } 

                    let retSize = parseInt(retObj.retSize);
                    if ( retSize === 0){
                        goodInfo("no trajectory meets the requirement");
                        return;
                    }
                    
                    if (retSize > 50){
                        goodInfo("There are "+retSize+" of qualified trajectories found, 50 of them are displayed.");
                    } else{
                        goodInfo("There are "+retSize+" of qualified trajectories found.")
                    }

                    // mapV API
                    // draw retrieved trajecory data on map
                    let data = retObj.ret;
                    let dataSet = new mapv.DataSet(data);
                    let options = {
                        fillStyle: 'rgba(135, 206, 250, 0.6)',
                        shadowColor: 'rgba(135, 206, 250, 1)',
                        shadowBlur: 30,
                        globalCompositeOperation: 'lighter',
                        methods: {
                            click: function (item) {
                                // console.log(item);
                            }
                        },
                        size: 5,
                        draw: 'simple'
                    };

                    let mapvLayer = new mapv.baiduMapLayer(map, dataSet, options);
                    dataSet.set(data); // 修改数据

                    // mapvLayer.show(); // 显示图层
                    // mapvLayer.hide(); // 删除图层
                },
                error: function(xhr) {
                    badInfo("server unavailable");
                }
            });
        });
    });
</script>

</body>
</html>
