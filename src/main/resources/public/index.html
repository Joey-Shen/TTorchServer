<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>TTorch</title>

    <style type="text/css">

        hr {
            display: block;
            height: 1px;
            border: 0;
            border-top: 1px solid #ccc;
            margin: 1em 0;
            padding: 0;
        }

    </style>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.2/css/bootstrap.min.css" integrity="sha384-Smlep5jCw/wG7hdkwQ/Z5nLIefveQRIY9nfy6xoR1uRYBtpZgI6339F5dgvm/e9B" crossorigin="anonymous">
    <link rel="stylesheet" href="http://api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/clusterize.js/0.18.0/clusterize.css" />
    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css" integrity="sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w" crossorigin="anonymous">
</head>
<body>

<div class="btn-group" style="margin-top: 50px; width: 40%;margin-left: 30%; margin-right: 30%; " role="group"
     aria-label="Basic example">
    <button id="btn0" type="button" style="margin-right: 1px" class="btn btn-primary" value=0>Similarity Search
    </button>
    <button id="btn1" type="button" style="margin-right: 1px" class="btn btn-secondary" value=1>Range Search
    </button>
    <button id="btn2" type="button" style="margin-right: 1px" class="btn btn-secondary" value=2>Path Query</button>
    <button id="btn3" type="button" style="margin-right: 1px" class="btn btn-secondary" value=3>Strict Path Query
    </button>
</div>

<div class="input-group mb-3" style="margin-top: 20px; width: 70%; margin-left:15%; margin-right: 15%;">
    <input type="text" id="input" class="form-control" size="25"
           placeholder="draw the window for RangeSearch, or the path for other types of queries"
           aria-label="search" aria-describedby="button-addon4" style="margin-left: 50px">
    <div class="input-group-append" id="button-addon4">
        <button class="btn btn-outline-danger" id="btnClear" type="button">Clear</button>
        <button class="btn btn-outline-success" id="btnSearch" style="margin-left: 1px" type="button">Search
        </button>
    </div>
</div>
<hr/>
<div id="info" class="alert alert-warning" role="alert"
     style="margin-left: 25%; margin-right: 25%; width: 50%; font-size: medium; display: none">
    <p>A simple warning alert—check it out!</p>
</div>
<div style="width: 100%; height: 100%">
    <div id="retPanel" style="float: left; width: 300px; height: 600px; margin-left: 15px; margin-right: 15px; display: none;">
        <p>Result Panel</p>
        <div class="clusterize">
            <table class="pure-table pure-table-horizontal" style="width: 100%; text-align:center">
                <thead>
                <tr>
                    <th>trajId</th>
                    <th>length</th>
                </tr>
                </thead>
            </table>

            <div id="scrollArea" class="clusterize-scroll">
                <table class="pure-table pure-table-horizontal" style="width: 100%; height:10px;text-align:center">
                    <tbody id="contentArea" class="clusterize-content">
                    <tr class="clusterize-no-data">
                        <td>Loading data…</td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div style="margin-top: 5px; ">
                <div class="progress">
                    <span class="badge badge-secondary" style="float: left">progress</span>
                    <div id="progressBar" class="progress-bar progress-bar-striped" role="progressbar" style="width: 100%; margin-left: 5px" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
        </div>
    </div>
    <div style="height: 600px; margin-left: 3%; margin-right: 3%" id="map"></div>
    <canvas id="canvas"></canvas>
</div>

<!-- JavaScript field -->
<script src="https://code.jquery.com/jquery-3.3.1.js"
        integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.2/js/bootstrap.min.js"
        integrity="sha384-o+RDsa0aLu++PJvFqy8fFScvbHFLtbvScb8AjopnFD+iEQ7wo/CG0xlczd+2O/em"
        crossorigin="anonymous"></script>
<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=o55gGAr8In322oxznMl5cojFABFo5hjE"></script>
<script type="text/javascript"
        src="http://api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.js"></script>
<script type="text/javascript"
        src="http://mapv.baidu.com/build/mapv.min.js"></script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/clusterize.js/0.18.0/clusterize.js"></script>

<script>

    const URL_PREFIX = "http://43.240.96.2";
    const TRAJ_ID_API = "/DEV/API/ID";

    const SIMILARITY_SEARCH = 0;
    const RANGE_SEARCH = 1;
    const PATH_QUERY = 2;
    const STRICT_PATH_QUERY = 3;
    const apiMap = {
        0:"/DEV/API/TKQ",
        1:"/DEV/API/RQ",
        2:"/DEV/API/PQ",
        3:"/DEV/API/SPQ"
    };

    $(document).ready(() => {

        //setup list view
        let ids = [];
        let map_data = [];
        let slot = [];

        function calc_cluster(progress) {
            return Math.floor(progress/100);
        }

        function calc_progress(overall_percentage){
            return Math.floor(overall_percentage * ids.length / 100)
        }

        let mapvLayer1;
        let mapvLayer2;
        let trajData;
        let timeData;

        function displayOnMap(clusterId) {
            // mapV API
            // draw retrieved trajecory map_data on map
            let times = [];
            console.log("display map data on cluster: "+clusterId);
            let trajs = map_data[clusterId];

            trajs.forEach(traj =>{

                let coordsArr = traj.geometry.coordinates;
                let i;
                for( i = 0; i < coordsArr.length; i ++){
                    times.push({
                        geometry: {
                            type: 'Point',
                            coordinates: [coordsArr[i][0], coordsArr[i][1]]
                        },
                        count:1,
                        time: i
                    })
                }
            });

            //draw red
            // let options = {
            //     fillStyle: 'rgba(255, 0, 0, 0.6)',
            //     shadowColor: 'rgba(255, 0, 0, 1)',
            //     shadowBlur: 30,
            //     globalCompositeOperation: 'lighter',
            //     methods: {
            //         click: function (item) {
            //             // console.log(item);
            //         }
            //     },
            //     size: 5,
            //     draw: 'simple'
            // };

            //draw blue
            let options1 = {
                strokeStyle: 'rgba(245,61,190,0.3)',
                //coordType: 'bd09mc',
                //globalCompositeOperation: 'lighter',
                shadowColor: 'rgba(53,57,255,0.4)',
                shadowBlur: 3,
                lineWidth: 3.0,
                draw: 'simple'
            };
            let options2 = {
                fillStyle: 'rgba(255, 250, 250, 0.5)',
                //coordType: 'bd09mc',
                globalCompositeOperation: "lighter",
                size: 1.5,
                animation: {
                    type:'time',
                    stepsRange: {
                        start: 0,
                        end: 400
                    },
                    trails: 1,
                    duration: 8,  //update every 8 seconds
                },
                draw: 'simple'
            };

            if (!mapvLayer1) {
                trajData = new mapv.DataSet(trajs);
                timeData = new mapv.DataSet(times);
                mapvLayer1 = new mapv.baiduMapLayer(map, trajData, options1);
                mapvLayer2 = new mapv.baiduMapLayer(map, timeData, options2);
            }else{
                trajData.set(trajs);
                timeData.set(times);
            }

            console.log("there");
            //timeData.set(); // 修改数据
            // mapvLayer1.show(); // 显示图层
            // mapvLayer2.show();
            // mapvLayer.hide(); // 删除图层
        }

        function downloadFullTraj(curCluster, firstTime) {
            console.log("curCluster: "+curCluster);
            console.log("slot: "+slot[curCluster]);
            if (slot[curCluster]) return;
            slot[curCluster] = true;
            let table_max_idx = ids.length - 1;
            let begin_idx = curCluster * 100;
            let end_idx = (curCluster+1) * 100 - 1;
            console.log("begin_idx: "+begin_idx);
            if (begin_idx >= table_max_idx) return;
            if (table_max_idx < end_idx)
                end_idx = table_max_idx;

            let url = URL_PREFIX + TRAJ_ID_API;

            let arr = [];
            //todo get ids and request for full trajectory.
            for (let i = begin_idx; i <= end_idx; i++) {
                arr.push(ids[i]);
            }

            $.ajax({
                url: url,
                data: {idSet : JSON.stringify(arr)},
                dataType:'json',
                cache: false,
                type: "GET",
                success: function(res) {
                    map_data[curCluster] = res;
                    console.log("find map_data for cluster: "+ curCluster);
                    if (firstTime)
                        displayOnMap(curCluster);
                },

                error: function(xhr) {
                    console.log("cannot download cluster: "+clusterize+" . Server unavailable");
                }
            });
        }

        let firstTime = true;
        let first = true;
        let maxClusterId;
        let retNum;

        let clusterize = new Clusterize({
            scrollId: 'scrollArea',
            contentId: 'contentArea',
            rows_in_block:100,          // display 100 records each time
            blocks_in_cluster:2,
            callbacks:{
                scrollingProgress:(percentage)=>{

                    // 1. display progress bar
                    let progress = calc_progress(percentage);
                    let curClusterId = calc_cluster(progress);
                    console.log("curClusterId: "+curClusterId);
                    console.log("progress: "+(percentage * ids.length / 100));

                    $('#progressBar').css('width', percentage+'%')
                                     .attr('aria-valuenow', percentage)
                                     .text(percentage.toFixed(2)+"%");

                    //2. download data for the first time
                    // if (first){
                    //     downloadFullTraj(curClusterId, true);
                    //     first = false;
                    // }
                    downloadFullTraj(curClusterId, true);

                    // no need to require trajectories if the stuff has been cached on client side
                    if ( map_data[curClusterId + 1]) return;
                    if (maxClusterId !== curClusterId) {
                        //2. download data for next round
                        // if (progress % 100 === 1) {
                        //     downloadFullTraj(curClusterId + 1, false);
                        // }
                        downloadFullTraj(curClusterId + 1, false);
                    }
                },

                clusterChanged: ()=>{

                    if (firstTime){
                        firstTime = false;
                        return;
                    }
                    let progress = calc_progress(clusterize.getScrollProgress());
                    if (progress === 0) return;

                    let curCluster = calc_cluster(progress);
                    console.log("cluster changed, cur Cluster: "+ curCluster);
                    displayOnMap(calc_cluster(progress));
                },
            }
        });

        // set listeners for query type selection group
        // record current selected btn.
        // 0 -- similarity search btn
        // 1 -- range search btn
        // 2 -- path query btn
        // 3 -- strict path query btn;
        let curBtnState = 0;
        for (let i = 0; i <= 3; i++) {
            let curBtn = $('#btn' + i);
            curBtn.click(() => {
                if (curBtnState !== i) {
                    $('#btn'+curBtnState).removeClass("btn-primary").addClass("btn-secondary");
                    curBtn.removeClass("btn-secondary").addClass("btn-primary");
                    curBtnState = parseInt(curBtn.val());
                    console.log(curBtn.val())
                }
            });
        }

        // baidu API
        let map = new BMap.Map("map");    // 创建Map实例
        map.centerAndZoom(new BMap.Point(-8.630568, 41.154795), 12);  // 初始化地图,设置中心点坐标和地图级别
        map.enableScrollWheelZoom(true); // 开启鼠标滚轮缩放
        var top_left_navigation = new BMap.NavigationControl();
        map.addControl(top_left_navigation);
        // map.setMapStyle({style: 'light'});

        // 地图自定义样式
        map.setMapStyle({
            styleJson: [{
                "featureType": "water",
                "elementType": "all",
                "stylers": {
                    "color": "#044161"
                }
            }, {
                "featureType": "land",
                "elementType": "all",
                "stylers": {
                    "color": "#091934"
                }
            }, {
                "featureType": "boundary",
                "elementType": "geometry",
                "stylers": {
                    "color": "#064f85"
                }
            }, {
                "featureType": "railway",
                "elementType": "all",
                "stylers": {
                    "visibility": "off"
                }
            }, {
                "featureType": "highway",
                "elementType": "geometry",
                "stylers": {
                    "color": "#004981"
                }
            }, {
                "featureType": "highway",
                "elementType": "geometry.fill",
                "stylers": {
                    "color": "#005b96",
                    "lightness": 1
                }
            }, {
                "featureType": "highway",
                "elementType": "labels",
                "stylers": {
                    "visibility": "on"
                }
            }, {
                "featureType": "arterial",
                "elementType": "geometry",
                "stylers": {
                    "color": "#004981",
                    "lightness": -10

                }
            }, {
                "featureType": "arterial",
                "elementType": "geometry.fill",
                "stylers": {
                    "color": "#00508b"
                }
            },{
                "featureType": "local",
                "elementType": "all",
                "stylers": {
                    "color": "#004981",
                    "lightness": -20
                }
            }, {
                "featureType": "local",
                "elementType": "geometry.fill",
                "stylers": {
                    "color": "#00508b"
                }
            }, {
                "featureType": "green",
                "elementType": "all",
                "stylers": {
                    "color": "#056197",
                    "visibility": "off"
                }
            }, {
                "featureType": "subway",
                "elementType": "all",
                "stylers": {
                    "visibility": "off"
                }
            }, {
                "featureType": "manmade",
                "elementType": "all",
                "stylers": {
                    "visibility": "off"
                }
            }, {
                "featureType": "boundary",
                "elementType": "geometry.fill",
                "stylers": {
                    "color": "#029fd4"
                }
            }, {
                "featureType": "building",
                "elementType": "all",
                "stylers": {
                    "visibility": "off"
                }
            }, {
                "featureType": "poi",
                "elementType": "labels.text.fill",
                "stylers": {
                    "color": "#ffffff"
                }
            }, {
                "featureType": "poi",
                "elementType": "labels.text.stroke",
                "stylers": {
                    "color": "#1e1c1c"
                }
            }]
        });

        let pathStyle = {
            strokeColor: "white",
            strokeWeight: 3,             // width of the stroke
            strokeOpacity: 0.8,
            strokeStyle: "white"        // solid or dashed
        };

        let rectStyle = {
            strokeColor: "white",
            fillColor: "white",
            strokeOpacity: 0.1,
            fillOpacity: 0.6,
            strokeStyle: "solid"
        };

        let drawer = new BMapLib.DrawingManager(map, {
            isOpen: false,                          // disable drawing mode
            enableDrawingTool: true,                // display tool bar
            drawingToolOptions: {
                anchor: BMAP_ANCHOR_TOP_RIGHT,      // position of the tool bar
                offset: new BMap.Size(10, 40),        // offset from the position
                scale: 0.8,
                drawingModes: [                    // functions on tool bar
                    // BMAP_DRAWING_MARKER,
                    // BMAP_DRAWING_CIRCLE,
                    BMAP_DRAWING_POLYLINE,
                    // BMAP_DRAWING_POLYGON,
                    BMAP_DRAWING_RECTANGLE
                ]
            },
            polylineOptions: pathStyle,
            rectangleOptions: rectStyle
        });

        function clear1() {
            ids = [];
            map_data = [];
            slot = [];
            clusterize.clear();
            $("#retPanel").hide();
            //$("#input").val("");
            map.clearOverlays();
            let infoElement = $('#info');
            infoElement.text("");
            infoElement.hide();
            first = true;
            mapvLayer1 = undefined;
            mapvLayer2 = undefined;
        }

        function badInfo( content) {
            let element = $('#info');
            element.removeClass("alert-success").addClass("alert-warning")
            element.text(content);
            element.show();
        }

        function goodInfo( content){
            let element = $('#info');
            element.removeClass("alert-warning").addClass("alert-success")
            element.text(content);
            element.show();
        }

        let lineComplete = function(line){

            if (curBtnState !== RANGE_SEARCH) {
                let temp = line.getPath();
                let path = "[";
                temp.forEach((item) => {
                    path += "[" + item.lat + "," + item.lng + "],"
                });
                path = path.substr(0, path.length - 1);
                path += "]";
                $("#input").val(path);
                $('#info').hide();
            }else{
                badInfo("Current query type do not support a PATH as query!")
            }
        };

        let rectComplete = (rect) => {

            console.log("cur btn state: "+curBtnState);
            console.log("range search: "+RANGE_SEARCH);

            if (curBtnState === RANGE_SEARCH) {
                // 0 -- upper left
                // 1 -- upper right
                // 2 -- lower right
                // 3 -- lower left
                let temp = [
                    rect.getPath()[0],
                    rect.getPath()[2]
                ];
                let window = "[";
                temp.forEach((item) => {
                    window += "[" + item.lat + "," + item.lng + "],"
                });
                window = window.substr(0, window.length - 1);
                window += "]";
                $("#input").val(window);
                $('#info').hide();
            }else{
                badInfo("Current query type do not support a WINDOW as query!");
            }
        };

        drawer.addEventListener("polylinecomplete", lineComplete);

        drawer.addEventListener("rectanglecomplete", rectComplete);


        // todo set listeners for clear button and submit button
        $("#btnClear").click(()=>{
            clear1();
        });

        function toTableData(ids) {
            let data = [];
            let counter = 0;
            ids.forEach(id => {
                data.push('<tr><td height="10px">'+id+'</td><td></td></tr>');
            });

            return data;
        }

        $("#btnSearch").click(()=>{

            let url = URL_PREFIX + apiMap[curBtnState];
            let data;
            console.log(url);
            let inputVal = $("#input").val();
            if (curBtnState === RANGE_SEARCH){
                console.log(inputVal.length);
                if (inputVal.length === 0) {
                    badInfo("A window for the query is required!");
                    return;
                }

                if (inputVal.split("],[").length !== 2) {
                    badInfo("A window is defined by an upper left point and a lower right point");
                    return;
                }
                data = {query: inputVal};
            } else {

                if (inputVal.length === 0) {
                    badInfo("A path for the query is required!");
                    return;
                }

                if (inputVal.split("],[").length < 2) {
                    badInfo("A path is defined by two or more points.\n Format: [[lat, lng],[lat, lng],[lat, lng]...]");
                    return;
                }

                if (curBtnState === SIMILARITY_SEARCH) {
                    data = {
                        query: inputVal,
                        k: 5
                    }
                }else {
                    data = {query: inputVal};
                }
            }

            console.log(data);

            goodInfo("The query is under processing, please wait...");

            $.ajax({
                url: url,
                data: data,
                dataType:'json',
                cache: false,
                type: "GET",
                success: function(res) {
                    // clear1();
                    console.log(res);
                    if (!res.formatCorrect) {
                        badInfo("Query is not in the right format. Please do double check!");
                        return;
                    }

                    let retObj = res.retObj;
                    if (!retObj.mappingSucceed){
                        badInfo("Query can not be properly map-matched to road network!")
                        return;
                    }

                    clear1();
                    let retSize = parseInt(retObj.retSize);
                    if ( retSize === 0){
                        goodInfo("no trajectory meets the requirement");
                        return;
                    }
                    
                    if (retSize > 100){
                        goodInfo("There are "+retSize+" of qualified trajectories found, 100 of them are displayed.");
                    } else{
                        goodInfo("There are "+retSize+" of qualified trajectories found.")
                    }
                    console.log(retObj.ids);
                    ids = retObj.ids;
                    clusterize.append(toTableData(ids));
                    maxClusterId = calc_cluster(ids.length - 1);
                    $("#retPanel").show();
                    for (let i = 0; i < ids.length; i++)
                        slot[i] = false;
                },
                error: function(xhr) {
                    badInfo("server unavailable");
                }
            });
        });
    });
</script>
</body>
</html>
